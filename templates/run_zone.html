{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2>âš™ï¸ Run Zone - ×¢×‘×•×“×” ××”×™×¨×” ×¢×œ ×›×™×ª×•×ª</h2>
            <p class="text-muted">×‘×—×¨ ×›×™×ª×”, ×¢×¨×•×š ×•×¨××” ×ª×•×¦××•×ª ×‘×–××Ÿ ×××ª</p>
        </div>
    </div>

    <!-- ×‘×—×™×¨×ª ×›×™×ª×” -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm border-info">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“š ×‘×—×¨ ×›×™×ª×” ×©××•×¨×”</h5>
                    <p class="card-text small text-muted">×¤×ª×— ×›×™×ª×” ×§×™×™××ª ×œ×¢×¨×™×›×” ×•×¢×¨×•×š ××•×ª×” ×›××Ÿ</p>
                    
                    {% if classes %}
                    <form id="classSelectForm">
                        <div class="mb-3">
                            <select class="form-select" id="classSelect" required onchange="loadClass()">
                                <option value="">-- ×‘×—×¨ ×›×™×ª×” --</option>
                                {% for class_name in class_names %}
                                <option value="{{ class_name }}">{{ class_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="classInfo" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>×¡×˜×•×“× ×˜×™×:</strong> <span id="studentCount">-</span><br>
                                <strong>×™×—×™×“×•×ª:</strong> <span id="unitCount">-</span>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-warning">
                        ××™×Ÿ ×›×™×ª×•×ª ×©××•×¨×•×ª ×¢×“×™×™×Ÿ. ×¦×•×¨ ×›×™×ª×” ×‘×“×£ ×”×‘×™×ª ×§×•×“×.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ×¢××•×“ ×”×¢×¨×™×›×” (×™×•×¤×™×¢ ××—×¨×™ ×‘×—×™×¨×ª ×›×™×ª×”) -->
    <div id="editZone" style="display: none;">
        <div class="row mb-4">
            <div class="col-md-12">
                <h4>âœï¸ ×¢×¨×™×›×ª ×™×—×™×“×•×ª</h4>
                <p class="small text-muted">×‘×—×¨ ×™×—×™×“×” ×›×“×™ ×œ×¢×¨×•×š ××ª ×”×“×™×¨×•×’×™×:</p>
            </div>
        </div>

        <div id="unitsEdit" class="row"></div>

        <div class="row mt-4">
            <div class="col-md-12">
                <h4>ğŸ¯ ×¤×¢×•×œ×•×ª</h4>
                <div class="d-grid gap-2">
                    <button class="btn btn-lg btn-warning" onclick="runOptimized()">
                        âš¡ ×”×¨×¦×” ×¨×’×™×œ×”
                    </button>
                    <button class="btn btn-lg btn-danger" onclick="runFullOptimized()">
                        ğŸš€ ××•×¤×˜×™××™×–×¦×™×” ××œ××”
                    </button>
                    <button class="btn btn-lg btn-success" onclick="saveAndClose()">
                        ğŸ’¾ ×©××•×¨ ×›×™×ª×” ×•×¡×’×•×¨
                    </button>
                    <button class="btn btn-lg btn-outline-secondary" onclick="closeEditZone()">
                        âŒ ×‘×˜×œ (×‘×œ×™ ×©××™×¨×”)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-md-12">
            <a href="/" class="btn btn-outline-secondary">ğŸ  ×—×–×•×¨ ×œ×¢××•×“ ×”×‘×™×ª</a>
        </div>
    </div>
</div>

<script>
function loadClass() {
    const className = document.getElementById('classSelect').value;
    if (!className) {
        document.getElementById('editZone').style.display = 'none';
        return;
    }
    
    // ×©×œ×™×—×” ×œ×©×¨×ª ×›×“×™ ×œ×§×‘×œ ××ª ×”× ×ª×•× ×™×
    fetch(`/get_class_data/${className}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('studentCount').textContent = data.students.length;
                document.getElementById('unitCount').textContent = Object.keys(data.units).length;
                document.getElementById('classInfo').style.display = 'block';
                document.getElementById('editZone').style.display = 'block';
                renderUnitsEdit(data.units);
            }
        });
}

function renderUnitsEdit(units) {
    const container = document.getElementById('unitsEdit');
    container.innerHTML = '';
    
    Object.entries(units).forEach(([unitName, unitData]) => {
        const html = `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6>${unitName}</h6>
                        <p class="small text-muted">×§×™×‘×•×œ×ª: ${unitData.capacity} | ×›×•×—: ${unitData.power.toFixed(2)}</p>
                        <a href="/rank/${unitName}" class="btn btn-sm btn-outline-primary" target="_blank">
                            ×¢×¨×•×š ×“×™×¨×•×’×™× âœï¸
                        </a>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function runOptimized() {
    const className = document.getElementById('classSelect').value;
    if (!className) {
        alert('×‘×—×¨ ×›×™×ª×” ×§×•×“×');
        return;
    }
    window.location.href = `/load_class/${className}`;
}

function runFullOptimized() {
    const className = document.getElementById('classSelect').value;
    if (!className) {
        alert('×‘×—×¨ ×›×™×ª×” ×§×•×“×');
        return;
    }
    window.location.href = `/run_class_optimized/${className}`;
}

function saveAndClose() {
    alert('××¤×©×¨×•×ª ×©××™×¨×” ×”×›×™×ª×” ×›×‘×¨ ×©××•×¨×”, ××ª×” ×™×›×•×œ ×œ×¡×’×•×¨ ×–××ª');
    window.location.href = '/';
}

function closeEditZone() {
    document.getElementById('editZone').style.display = 'none';
    document.getElementById('classSelect').value = '';
}
</script>

{% endblock %}
