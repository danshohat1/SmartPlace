{% extends 'base.html' %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>ğŸ“Š Dashboard ×›×™×ª×”: {{ class_name }}</h2>
        </div>
        <div class="col-md-4">
            <div class="btn-group w-100" role="group">
                <a href="/load_class/{{ class_name }}" class="btn btn-warning">âš¡ ×”×¨×¦×” ×¨×’×™×œ×”</a>
                <a href="/run_class_optimized/{{ class_name }}" class="btn btn-danger">ğŸš€ ××•×¤×˜×™××™×–×¦×™×”</a>
                <a href="/classes" class="btn btn-outline-secondary">â†©ï¸ ×—×–×•×¨</a>
            </div>
        </div>
    </div>

    <!-- ×¤×¨×˜×™ ×”×›×™×ª×” -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="alert alert-info">
                <strong>ğŸ“‹ ×¤×¨×˜×™ ×”×›×™×ª×”:</strong> 
                ×¡×˜×•×“× ×˜×™×: {{ student_count }} | 
                ×™×—×™×“×•×ª: {{ unit_count }} | 
                × ×•×¦×¨×”: {{ class_data.created_date }}
            </div>
        </div>
    </div>

    <!-- ×—×™×¤×•×© ×¡×˜×•×“× ×˜ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm border-info mb-4">
                <div class="card-body">
                    <h5 class="card-title">ğŸ” ×—×¤×© ×¡×˜×•×“× ×˜</h5>
                    <div class="mb-3">
                        <input type="text" id="studentSearch" class="form-control form-control-lg" placeholder="×”×§×œ×“ ×©× ×¡×˜×•×“× ×˜..." onkeyup="searchStudent()">
                    </div>
                    
                    <!-- ×ª×•×¦××•×ª ×—×™×¤×•×© -->
                    <div id="searchResults" style="display: none;">
                        <hr>
                        <h6>ğŸ‘¤ <span id="studentName"></span></h6>
                        <p class="text-muted small">×¡×“×¨ ×”×¢×“×¤×•×ª ×”×™×—×™×“×•×ª:</p>
                        <ol id="prefsList" class="list-group">
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ×¢×¨×™×›×ª ×™×—×™×“×•×ª - ×‘×™×¦×•×’ ×§×•××¤×§×˜×™ -->
    <div class="row">
        <div class="col-md-12">
            <h4 class="mb-3">ğŸ¢ ×™×—×™×“×•×ª ×•×§×•× ×¤×™×’×•×¨×¦×™×”</h4>
            <div class="row" id="unitsContainer">
                <!-- ×™×—×™×“×•×ª ×™×ª×•×¡×¤×• ×›××Ÿ ×‘×××¦×¢×•×ª JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal ×œ×¢×¨×™×›×ª ×“×™×¨×•×’×™× -->
<div class="modal fade" id="editPrefsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">âœï¸ ×¢×¨×™×›×ª ×“×™×¨×•×’×™× - <span id="modalUnitName"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- ×—×™×¤×•×© ×•×—× ×•×ª ×¡×˜×•×“× ×˜×™× -->
                    <div class="col-md-4">
                        <div class="sticky-top" style="top: 0; z-index: 100;">
                            <h6 class="mb-2">ğŸ” ×¡×˜×•×“× ×˜×™× ×–××™× ×™×</h6>
                            <input type="text" id="studentSearchInModal" class="form-control form-control-sm mb-2" 
                                   placeholder="×—×¤×© ×¡×˜×•×“× ×˜...">
                            
                            <div id="studentsPool" class="border rounded p-2" style="min-height: 400px; max-height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                                <!-- ×¡×˜×•×“× ×˜×™× ×™×•×¤×™×¢×• ×›××Ÿ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- ×¨××•×ª ×“×™×¨×•×’ -->
                    <div class="col-md-8">
                        <h6 class="mb-3">ğŸ“Š ×¨××•×ª ×“×™×¨×•×’</h6>
                        <div id="prefsContainer" class="space-y-3">
                            <!-- ×¨××•×ª ×™×•×¤×™×¢×• ×›××Ÿ -->
                        </div>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-3" onclick="addNewTierModal()">
                            â• ×”×•×¡×£ ×¨××ª ×“×™×¨×•×’ ×—×“×©×”
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" onclick="savePrefsModal()">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ×œ×¢×¨×™×›×ª ×¤×¨×˜×™ ×™×—×™×“×” -->
<div class="modal fade" id="editUnitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">âš™ï¸ ×”×’×“×¨×•×ª - <span id="modalUnitName2"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">×§×™×‘×•×œ×ª:</label>
                    <input type="number" id="modalCapacity" class="form-control" placeholder="×”×›× ×¡ ×§×™×‘×•×œ×ª">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">×›×•×— ×™×—×™×“×” (Power):</label>
                    <input type="number" id="modalPower" step="0.01" class="form-control" placeholder="×”×›× ×¡ ×›×•×—">
                </div>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="modalStickyPower">
                        <label class="form-check-label fw-bold" for="modalStickyPower">
                            ğŸ”’ ×›×•×— ×—×–×§ (×‘×¨×–×œ) - ×©××•×¨ Power ×‘×¢×ª ××•×¤×˜×™××™×–×¦×™×”
                        </label>
                    </div>
                    <small class="text-muted d-block mt-2">×× ××¡×•××Ÿ, ×¢×¨×š ×”×›×•×— ×©×œ ×”×™×—×™×“×” ×”×–×• ×œ× ×™×©×ª× ×” ×‘×¢×ª ×”×¨×¦×ª ××•×¤×˜×™××™×–×¦×™×” ××œ××”</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" onclick="saveUnitSettingsModal()">ğŸ’¾ ×©××•×¨</button>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// × ×ª×•× ×™× ×©×œ ×”×¡×˜×•×“× ×˜×™× ×•×”×™×—×™×“×•×ª
const studentsData = {{ class_data.students | tojson }};
const unitsData = {{ class_data.units | tojson }};
const className = {{ class_name | tojson }};

// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ-modals
let currentEditingUnit = null;
let editingPrefs = null;
let filteredStudents = [];

// ×‘×™×˜×—×•×Ÿ ×ª×—×“ ×˜×¢×™× ×”
document.addEventListener('DOMContentLoaded', function() {
    renderUnits();
});

function renderUnits() {
    const container = document.getElementById('unitsContainer');
    container.innerHTML = '';
    
    Object.entries(unitsData).forEach(([unitName, unitData]) => {
        const card = document.createElement('div');
        card.className = 'col-md-4 mb-3';
        
        // Escape unit name for use in JavaScript
        const escapedUnitName = unitName.replace(/"/g, '&quot;');
        const displayName = unitName.replace(/"/g, '×´');
        
        card.innerHTML = `
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title mb-3">ğŸ“ ${displayName} ${unitData.sticky_power ? 'ğŸ”’' : ''}</h6>
                    
                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1">×§×™×‘×•×œ×ª:</small>
                        <strong class="fs-6">${unitData.capacity} ××§×•××•×ª</strong>
                    </div>
                    
                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1">×›×•×—:</small>
                        <div>
                            <strong class="fs-6">${unitData.power.toFixed(2)}</strong>
                            ${unitData.sticky_power ? '<span class="badge bg-warning text-dark ms-2">×‘×¨×–×œ</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="mb-4 pb-3 border-bottom">
                        <small class="text-muted d-block mb-2">ğŸ“Š ×“×™×¨×•×’×™×:</small>
                        <div class="d-flex flex-wrap gap-1">
                            ${unitData.prefs.map((tier, idx) => {
                                const count = Array.isArray(tier) ? tier.length : 1;
                                return `<span class="badge bg-light text-dark border">×¨××” ${idx + 1}: ${count} ×¡'</span>`;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="mt-auto d-grid gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditPrefsModal('${escapedUnitName}')">
                            âœï¸ ×¢×¨×•×š ×“×™×¨×•×’×™×
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="openEditSettingsModal('${escapedUnitName}')">
                            âš™ï¸ ×”×’×“×¨×•×ª
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function openEditSettingsModal(unitName) {
    currentEditingUnit = unitName;
    const unitData = unitsData[unitName];
    
    document.getElementById('modalUnitName2').textContent = unitName;
    document.getElementById('modalCapacity').value = unitData.capacity;
    document.getElementById('modalPower').value = unitData.power.toFixed(2);
    document.getElementById('modalStickyPower').checked = unitData.sticky_power || false;
    
    const modal = new bootstrap.Modal(document.getElementById('editUnitModal'));
    modal.show();
}

function saveUnitSettingsModal() {
    const capacity = parseInt(document.getElementById('modalCapacity').value);
    const power = parseFloat(document.getElementById('modalPower').value);
    const stickyPower = document.getElementById('modalStickyPower').checked;
    
    if (!currentEditingUnit) return;
    
    unitsData[currentEditingUnit].capacity = capacity;
    unitsData[currentEditingUnit].power = power;
    unitsData[currentEditingUnit].sticky_power = stickyPower;
    
    saveAllChanges();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editUnitModal'));
    modal.hide();
    
    renderUnits();
}

function openEditPrefsModal(unitName) {
    currentEditingUnit = unitName;
    editingPrefs = JSON.parse(JSON.stringify(unitsData[unitName].prefs)); // deep copy
    
    document.getElementById('modalUnitName').textContent = unitName;
    
    // × ×™×§×•×™ ×—×™×¤×•×©
    document.getElementById('studentSearchInModal').value = '';
    
    renderStudentsPool();
    renderPrefsInModal();
    
    const modal = new bootstrap.Modal(document.getElementById('editPrefsModal'));
    modal.show();
}

function renderStudentsPool() {
    const searchInput = document.getElementById('studentSearchInModal').value.toLowerCase();
    const container = document.getElementById('studentsPool');
    container.innerHTML = '';
    
    // ×—×™×¤×•×© ×¡×˜×•×“× ×˜×™× ×œ×¤×™ ×˜×§×¡×˜
    filteredStudents = studentsData.filter(student => 
        student.name.toLowerCase().includes(searchInput)
    );
    
    if (filteredStudents.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mt-5">××™×Ÿ ×¡×˜×•×“× ×˜×™× ×œ×ª×¦×•×’×”</p>';
        return;
    }
    
    filteredStudents.forEach(student => {
        const badge = document.createElement('div');
        badge.className = 'btn btn-sm btn-outline-primary m-1';
        badge.draggable = true;
        badge.textContent = student.name;
        badge.style.cursor = 'grab';
        
        badge.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('studentName', student.name);
        });
        
        badge.addEventListener('dragend', (e) => {
            badge.style.opacity = '1';
        });
        
        container.appendChild(badge);
    });
}

function renderPrefsInModal() {
    const container = document.getElementById('prefsContainer');
    container.innerHTML = '';
    
    editingPrefs.forEach((tier, tierIndex) => {
        const tierDiv = document.createElement('div');
        tierDiv.className = 'mb-3 p-3 bg-light rounded border-2 border-secondary';
        tierDiv.id = `tier-${tierIndex}`;
        
        const students = Array.isArray(tier) ? tier : [tier];
        
        tierDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <label class="form-label mb-0 fw-bold">ğŸ¯ ×¨××” ${tierIndex + 1}</label>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTierModal(${tierIndex})">
                    ğŸ—‘ï¸ ××—×§ ×¨××”
                </button>
            </div>
            <div class="tier-drop-zone" data-tier="${tierIndex}" style="min-height: 50px; background-color: white; border: 2px dashed #ccc; border-radius: 4px; padding: 10px;">
                <!-- ×¡×˜×•×“× ×˜×™× ×‘×’×¨×™×¨×” ×™×•×¤×™×¢×• ×›××Ÿ -->
            </div>
        `;
        
        const dropZone = tierDiv.querySelector('.tier-drop-zone');
        
        // ×”×•×¡×£ ××ª ×”×¡×˜×•×“× ×˜×™× ×©×›×‘×¨ ×‘×¨××”
        students.forEach((studentName, studentIndex) => {
            const studentBadge = document.createElement('span');
            studentBadge.className = 'badge bg-success me-2 mb-2';
            studentBadge.style.cursor = 'pointer';
            studentBadge.dataset.tierIndex = tierIndex;
            studentBadge.dataset.studentIndex = studentIndex;
            studentBadge.dataset.studentName = studentName;
            studentBadge.innerHTML = `${studentName} <span class="ms-1" style="cursor: pointer;">âœ•</span>`;
            
            // ×”×•×¡×£ event listener ×œ×”×¡×¨×”
            studentBadge.querySelector('span').addEventListener('click', (e) => {
                e.stopPropagation();
                removeStudentFromTier(tierIndex, studentName);
            });
            
            dropZone.appendChild(studentBadge);
        });
        
        // ×”×•×¡×£ event listeners ×œdrop zone
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#e7f3ff';
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            dropZone.style.backgroundColor = 'white';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'white';
            
            const studentName = e.dataTransfer.getData('studentName');
            addStudentToTier(tierIndex, studentName);
            saveAllChanges();
            renderPrefsInModal();
            renderStudentsPool();
        });
        
        container.appendChild(tierDiv);
    });
}

function addStudentToTier(tierIndex, studentName) {
    if (!editingPrefs[tierIndex]) return;
    
    const tier = editingPrefs[tierIndex];
    const tierArray = Array.isArray(tier) ? tier : [tier];
    
    // ×‘×“×™×§×” ×× ×”×¡×˜×•×“× ×˜ ×›×‘×¨ ×‘×¨××”
    if (tierArray.includes(studentName)) return;
    
    tierArray.push(studentName);
    editingPrefs[tierIndex] = tierArray;
}

function removeStudentFromTier(tierIndex, studentName) {
    if (!editingPrefs[tierIndex]) return;
    
    const tier = editingPrefs[tierIndex];
    let tierArray = Array.isArray(tier) ? tier : [tier];
    
    tierArray = tierArray.filter(s => s !== studentName);
    editingPrefs[tierIndex] = tierArray.length === 0 ? '' : tierArray.length === 1 ? tierArray[0] : tierArray;
    
    saveAllChanges();
    // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×”
    renderPrefsInModal();
    renderStudentsPool();
}

function removeTierModal(tierIndex) {
    if (confirm('×”×× ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¨××” ×”×–×•?')) {
        editingPrefs.splice(tierIndex, 1);
        saveAllChanges();
        renderPrefsInModal();
    }
}

function addNewTierModal() {
    editingPrefs.push([]);
    saveAllChanges();
    renderPrefsInModal();
}

function savePrefsModal() {
    if (!currentEditingUnit) return;
    
    const newPrefs = [];
    document.querySelectorAll('.tier-drop-zone').forEach(zone => {
        const badges = zone.querySelectorAll('span.badge');
        const students = Array.from(badges).map(badge => {
            // ×§×‘×œ ××ª ×”×˜×§×¡×˜ ×‘×œ×™ ×”×—×œ×§ ×©×œ ×”-âœ•
            return badge.textContent.trim().replace('âœ•', '').trim();
        }).filter(s => s);
        
        if (students.length > 0) {
            newPrefs.push(students.length === 1 ? students[0] : students);
        }
    });
    
    unitsData[currentEditingUnit].prefs = newPrefs;
    
    saveAllChanges();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editPrefsModal'));
    modal.hide();
    
    renderUnits();
}

function saveAllChanges() {
    console.log('Saving changes for class:', className);
    console.log('Units data:', JSON.stringify(unitsData, null, 2));
    
    fetch(`/update_class`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            class_name: className,
            units: unitsData
        })
    })
    .then(r => {
        console.log('Response status:', r.status);
        return r.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            showSuccessAlert('×›×œ ×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”');
        } else {
            showErrorAlert('×©×’×™××”: ' + (data.error || '×œ× ×™×“×•×¢'));
        }
    })
    .catch(err => {
        console.error('Fetch error:', err);
        showErrorAlert('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×');
    });
}

function showSuccessAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

function showErrorAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 4000);
}

// Setup search listener
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('studentSearchInModal');
    if (searchInput) {
        searchInput.addEventListener('keyup', () => {
            renderStudentsPool();
        });
    }
});

function searchStudent() {
    const query = document.getElementById('studentSearch').value.toLowerCase();
    
    if (!query) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }
    
    // ×—×™×¤×•×© ×¡×˜×•×“× ×˜
    const student = studentsData.find(s => s.name.toLowerCase().includes(query));
    
    if (!student) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }
    
    // ×”×¦×’×ª ×”×ª×•×¦××•×ª
    document.getElementById('studentName').textContent = student.name;
    
    const prefsList = document.getElementById('prefsList');
    prefsList.innerHTML = '';
    
    const prefs = student.prefs || [];
    prefs.forEach((unit, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <span>${unit}</span>
            <span class="badge bg-primary rounded-pill">${index + 1}</span>
        `;
        prefsList.appendChild(li);
    });
    
    document.getElementById('searchResults').style.display = 'block';
}
</script>

{% endblock %}
